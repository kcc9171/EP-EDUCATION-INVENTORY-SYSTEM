<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Accounts â€” Admin</title>
<link rel="icon" href="https://media.licdn.com/dms/image/v2/C560BAQH1e7RqZpFCqA/company-logo_200_200/company-logo_200_200/0/1630649511750?e=2147483647&v=beta&t=Xt8U3KJxbI4FiV1rmcsehbP6Y2XdByD6pEP8X7K378g">
<style>
  :root{
    --bg:#F7F4EA; --panel:#EEE6D8; --ink:#1F2937; --muted:#6B7280;
    --line:#D9CFC1; --accent:#0EA5A4; --shadow:0 12px 30px rgba(0,0,0,.08);
    --chip:#EDE7DA; --header:#F0E8DB;
  }
  *{box-sizing:border-box}
  body{margin:0;min-height:100vh;background:var(--bg);color:var(--ink);font-family:Arial,system-ui}
  .wrap{max-width:1060px;margin:0 auto;padding:18px}
  .bar{display:flex;gap:16px;align-items:center;justify-content:space-between;margin-bottom:10px}
  .brand{display:flex;align-items:center;gap:12px}
  .logo{width:44px;height:44px;border-radius:10px;object-fit:cover;background:#fff;border:1px solid var(--line);box-shadow:var(--shadow)}
  h1{margin:0}
  .muted{color:var(--muted)}
  .btn{padding:8px 12px;border:1px solid var(--accent);border-radius:8px;background:var(--accent);color:#fff;cursor:pointer;transition:.15s}
  .btn:hover{filter:brightness(.95)}
  .btn--ghost{background:transparent;color:var(--ink)}
  .btn--danger{background:#b91c1c;border-color:#b91c1c}
  .tabs{display:flex;gap:8px;margin:8px 0 14px;flex-wrap:wrap}
  .tab{padding:8px 12px;border:1px solid var(--line);border-radius:8px;background:var(--panel);cursor:pointer}
  .tab.active,.tab:hover{background:var(--accent);color:#fff;border-color:var(--accent)}
  .section{display:none}.section.show{display:block}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:12px;box-shadow:var(--shadow);padding:16px}
  label{display:block;font-size:14px;margin:.25rem 0}
  input,select{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:8px;background:#fff;color:var(--ink)}
  .grid{display:grid;grid-template-columns:1fr 1fr 200px;gap:12px;align-items:end;max-width:760px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .pill{padding:2px 8px;border:1px solid var(--line);border-radius:999px;background:var(--chip);font-size:12px}
  .note{font-size:12px;color:var(--muted);margin-top:6px}
  table{width:100%;border-collapse:collapse;background:var(--panel);color:var(--ink)}
  th,td{border:1px solid var(--line);padding:8px;text-align:left}
  thead th{background:var(--header);color:var(--muted)}
</style>
</head>
<body>
  <div class="wrap">
    <div class="bar">
      <div class="brand">
        <img class="logo" alt="Company logo"
             src="https://media.licdn.com/dms/image/v2/C560BAQH1e7RqZpFCqA/company-logo_200_200/company-logo_200_200/0/1630649511750?e=2147483647&v=beta&t=Xt8U3KJxbI4FiV1rmcsehbP6Y2XdByD6pEP8X7K378g"/>
        <div>
          <h1>Accounts</h1>
          <div class="muted">Create & manage users (admin only)</div>
        </div>
      </div>
      <div class="row">
        <a class="btn btn--ghost" href="viewer.html">Viewer</a>
        <a class="btn btn--ghost" href="index.html">Editor Tools</a>
        <span id="signedAs" class="muted"></span>
        <button id="logoutBtn" class="btn">Logout</button>
      </div>
    </div>

    <div class="tabs">
      <div class="tab active" data-tab="create">Create Account</div>
      <div class="tab" data-tab="manage">Manage Account</div>
    </div>

    <!-- Create -->
    <section id="create" class="section show">
      <div class="card">
        <div class="grid">
          <div>
            <label for="new-username">Username</label>
            <input id="new-username" type="text" placeholder="e.g. alice" autocomplete="off"/>
          </div>
          <div>
            <label for="new-password">Password</label>
            <input id="new-password" type="text" placeholder="Set a password"/>
          </div>
          <div>
            <label for="new-role">Role</label>
            <select id="new-role">
              <option value="viewer">viewer</option>
              <option value="editor">editor</option>
            </select>
          </div>
        </div>
        <div class="row" style="margin-top:12px">
          <button id="createBtn" class="btn">Create Account</button>
          <button id="resetBtn" class="btn btn--ghost">Clear</button>
        </div>
        <div class="note">Usernames are case-sensitive. Creating new admins here is disabled.</div>
      </div>
    </section>

    <!-- Manage -->
    <section id="manage" class="section">
      <div class="card" style="overflow:auto">
        <table>
          <thead>
            <tr>
              <th>Username</th>
              <th>Role</th>
              <th>Password</th>
              <th style="width:220px">Actions</th>
            </tr>
          </thead>
          <tbody id="acctBody"></tbody>
        </table>
      </div>
      <div class="note">Protected users cannot be deleted or demoted.</div>
    </section>
  </div>

<script>
// --- GH Pages-safe helper for redirects/links ---
function ghBase(file) {
  if (location.hostname.endsWith('github.io')) {
    const parts = location.pathname.split('/').filter(Boolean);
    const repo = parts.length > 0 ? parts[0] : '';
    return (repo ? `/${repo}/` : '/') + file;
  }
  return file;
}

/* --------- Auth gate: only admin --------- */
const ok   = localStorage.getItem('auth_v1') === 'ok';
const role = localStorage.getItem('auth_role');
const user = localStorage.getItem('auth_user') || '';
if (!ok || role !== 'admin') { window.location.replace(ghBase('login.html')); }
document.getElementById('signedAs').textContent = `Signed in as ${user} (admin)`;
document.getElementById('logoutBtn').addEventListener('click', () => {
  localStorage.removeItem('auth_v1');
  localStorage.removeItem('auth_user');
  localStorage.removeItem('auth_role');
  localStorage.removeItem('auth_time');
  window.location.replace(ghBase('login.html'));
});

/* --------- UI tabs --------- */
document.querySelectorAll('.tab').forEach(t=>{
  t.addEventListener('click',()=>{
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    document.querySelectorAll('.section').forEach(s=>s.classList.remove('show'));
    t.classList.add('active');
    document.getElementById(t.dataset.tab).classList.add('show');
  });
});

/* --------- Accounts store (localStorage) --------- */
const ACCOUNTS_KEY = 'accounts_v1';
const PROTECTED = { 'EPEDUADMIN': 'admin' }; // cannot delete or demote

// Seed first run with your existing users + admin
function seedIfMissing(){
  if (localStorage.getItem(ACCOUNTS_KEY)) return;
  const seeded = {
    "EPEDU":     { hash: "dcb29d675b72d042c839362546f63501afd9130965b0193b1718c2e6bd99ca80", role: "editor" },
    "gwenntan":  { hash: "9440524470c0fd7f13b67eeb3a56354a46158c04f82b660f50fa96da3b481b48", role: "editor" },
    "EPSUPPORT": { hash: "844bfaecdd264b1422e6ccb9bd789757fe34c358d76edf2d0790e0b0997882e3", role: "viewer" },
    "Sally Kan": { hash: "d3dc9ee2aecc08b4b60b1258449a96c5b0ee80bb61964915f2918a4b36dbe39b", role: "editor" },
    /* Admin: EPEDUADMIN / EPEDUADMIN2000 */
    "EPEDUADMIN":{ hash: "6c92215682dcb0759435e1f2b971489706180f64f145029e2d46ef9d0db54507", role: "admin" }
  };
  localStorage.setItem(ACCOUNTS_KEY, JSON.stringify(seeded));
}
seedIfMissing();

function loadAccounts(){ try{ return JSON.parse(localStorage.getItem(ACCOUNTS_KEY)) || {}; }catch{ return {}; } }
function saveAccounts(obj){ localStorage.setItem(ACCOUNTS_KEY, JSON.stringify(obj)); }

/* --------- Helpers --------- */
async function sha256Hex(text){
  const enc = new TextEncoder().encode(text);
  const hash = await crypto.subtle.digest('SHA-256', enc);
  return Array.from(new Uint8Array(hash)).map(b=>b.toString(16).padStart(2,'0')).join('');
}
function toast(m){ alert(m); }

/* --------- Create tab --------- */
const uEl = document.getElementById('new-username');
const pEl = document.getElementById('new-password');
const rEl = document.getElementById('new-role');

document.getElementById('resetBtn').addEventListener('click', ()=>{
  uEl.value=''; pEl.value=''; rEl.value='viewer';
});
document.getElementById('createBtn').addEventListener('click', async ()=>{
  const username = (uEl.value||'').trim();
  const password = (pEl.value||'').trim();
  const role = rEl.value;
  if (!username || !password){ toast('Enter username and password'); return; }
  const accounts = loadAccounts();
  if (accounts[username]){ toast('That username already exists'); return; }
  if (role === 'admin'){ toast('Creating new admin accounts is disabled'); return; }
  accounts[username] = { hash: await sha256Hex(password), role };
  saveAccounts(accounts);
  toast(`Created "${username}" as ${role}`);
  uEl.value=''; pEl.value=''; rEl.value='viewer';
  renderManage();
});

/* --------- Manage tab --------- */
const tbody = document.getElementById('acctBody');
function renderManage(){
  const accounts = loadAccounts();
  const entries = Object.entries(accounts).sort((a,b)=>a[0].localeCompare(b[0]));
  tbody.innerHTML = '';
  for (const [username, data] of entries){
    const id = username.replace(/\W/g,'_');
    const prot = PROTECTED[username];
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${username}${prot? ' <span class="pill" title="Protected">locked</span>':''}</td>
      <td>${
        prot ? `<span class="pill">admin</span>` :
        `<select id="role-${id}">
           <option value="viewer"${data.role==='viewer'?' selected':''}>viewer</option>
           <option value="editor"${data.role==='editor'?' selected':''}>editor</option>
         </select>`
      }</td>
      <td><input type="text" id="pw-${id}" placeholder="Set new password"/></td>
      <td>
        <div class="row">
          <button class="btn btn--ghost" data-act="save" data-u="${username}">Save</button>
          <button class="btn btn--danger" data-act="del"  data-u="${username}">Delete</button>
        </div>
      </td>
    `;
    tbody.appendChild(tr);
  }

  tbody.querySelectorAll('button[data-act]').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const act = btn.dataset.act, u = btn.dataset.u;
      const accounts = loadAccounts();
      if (!accounts[u]){ toast('User not found'); return; }

      if (act === 'del'){
        if (u in PROTECTED){ toast('Cannot delete protected/admin account'); return; }
        delete accounts[u];
        saveAccounts(accounts); toast(`Deleted "${u}"`); renderManage(); return;
      }

      if (act === 'save'){
        if (!(u in PROTECTED)){
          const roleSel = document.getElementById(`role-${u.replace(/\W/g,'_')}`);
          if (roleSel) accounts[u].role = roleSel.value;
        }
        const pwEl = document.getElementById(`pw-${u.replace(/\W/g,'_')}`);
        const newPw = (pwEl?.value||'').trim();
        if (newPw){ accounts[u].hash = await sha256Hex(newPw); pwEl.value=''; }
        saveAccounts(accounts); toast(`Saved "${u}"`); renderManage(); return;
      }
    });
  });
}
renderManage();
</script>
</body>
</html>
