<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Inventory System ‚Äî Add New Stock</title>

<!-- Auth gate with role check -->
<script>
  const AUTH_OK   = localStorage.getItem('auth_v1') === 'ok';
  const AUTH_USER = localStorage.getItem('auth_user');
  const AUTH_ROLE = localStorage.getItem('auth_role'); // 'editor' | 'viewer'
  if (!AUTH_OK || !AUTH_USER) { window.location.replace('login.html'); }
  else if (AUTH_ROLE === 'viewer') { window.location.replace('viewer.html'); }
  function logout(){
    localStorage.removeItem('auth_v1');
    localStorage.removeItem('auth_user');
    localStorage.removeItem('auth_role');
    localStorage.removeItem('auth_time');
    window.location.replace('login.html');
  }
</script>

<style>
  /* ==== Light theme based on #F7F4EA ==== */
  :root{
    --nav-w:260px;

    /* Theme */
    --bg:#F7F4EA;        /* paper background */
    --panel:#EEE6D8;     /* cards / panels */
    --ink:#1F2937;       /* primary text */
    --muted:#6B7280;     /* muted text */
    --line:#D9CFC1;      /* borders/outlines */
    --accent:#0EA5A4;    /* teal accent */
    --chip:#EDE7DA;      /* subtle chip/pill bg */

    /* Helper card accents */
    --helper-accent:#6D28D9;
    --helper-panel:#F3ECDF;
    --shadow:0 10px 24px rgba(0,0,0,.08);
  }

  html,body{height:100%}
  body{
    margin:0;
    font-family:Arial,sans-serif;
    background:var(--bg);
    color:var(--ink)
  }
  h1,h2,h3{color:var(--ink)}
  .content{padding:20px;padding-top:80px;min-height:100vh;box-sizing:border-box}

  /* Controls ‚Äî simple + consistent heights */
  .btn, .input, select{
    height:42px;
    padding:0 12px;
    font-size:16px;
    border:1px solid var(--line);
    background:var(--panel);
    color:var(--ink);
    border-radius:10px;
  }
  input[type="number"]{ -moz-appearance:textfield; }
  input::-webkit-outer-spin-button,
  input::-webkit-inner-spin-button{ -webkit-appearance: none; margin:0; }

  .btn{
    cursor:pointer;
    transition:.15s ease;
    white-space:nowrap
  }
  .btn:hover{
    background:var(--accent);
    color:#ffffff;
    border-color:var(--accent);
  }

  .muted{color:var(--muted);font-size:12px;margin-top:6px}

  /* Sidebar + hamburger */
  #menu-check{display:none}
  .hamburger{
    position:fixed;left:12px;top:12px;width:32px;display:flex;flex-direction:column;gap:7px;
    cursor:pointer;user-select:none;z-index:1200;transition:transform .3s
  }
  .hamburger .bar{
    height:3px;background:var(--ink);border-radius:10px
  }
  #menu-check:checked+label.hamburger{transform:translateX(var(--nav-w))}
  #menu-check:checked+label.hamburger .bar{}

  .sidebar{
    position:fixed;inset:0 auto 0 0;width:var(--nav-w);
    background:var(--panel);padding:20px;box-sizing:border-box;
    transform:translateX(-100%);transition:.3s;z-index:1100;overflow:auto;
    box-shadow:var(--shadow);border-right:1px solid var(--line)
  }
  .sidebar a,.sidebar button{
    display:block;width:100%;margin-bottom:10px;padding:10px;text-align:left;border-radius:8px;text-decoration:none;
    color:inherit;border:1px solid var(--line);background:transparent
  }
  .sidebar a:hover{background:var(--accent);color:#fff;border-color:var(--accent)}
  #menu-check:checked~.sidebar{transform:translateX(0)}
  label.overlay{position:fixed;inset:0;background:rgba(0,0,0,.25);opacity:0;visibility:hidden;transition:.3s;z-index:1090}
  #menu-check:checked~label.overlay{opacity:1;visibility:visible}

  /* Add form: tidy, aligned, responsive */
  .add-form{
    display:grid;
    grid-template-columns: minmax(240px, 1.2fr) 160px 240px auto;
    gap:12px;
    align-items:center;
    max-width:980px;
  }
  @media (max-width: 820px){
    .add-form{ grid-template-columns: 1fr 1fr; }
    .add-form .stack-span{ grid-column: 1 / -1; }
  }

  /* Helper card (themed) */
  .helper-row{display:grid;grid-template-columns:1fr;gap:16px;margin-top:16px}
  .card.helper{
    width:100%;border-radius:15px;background:var(--helper-panel);color:var(--ink);padding:24px 16px;
    box-shadow:var(--shadow);border:1px solid var(--line);position:relative
  }
  .card-border-top{
    width:65%;height:4px;background:var(--helper-accent);
    margin:0 auto 14px;border-radius:0 0 14px 14px
  }
  .card.helper .img{
    width:64px;height:64px;background:#fff;border-radius:14px;margin:8px auto 10px;
    display:flex;align-items:center;justify-content:center;font-size:28px;border:1px solid var(--line)
  }
  .card.helper span{display:block;text-align:center}
  .card.helper .job{font-size:13px;color:var(--muted)}
  .card.helper .btn{display:inline-flex;align-items:center;gap:8px}
  .helper-actions{display:flex;align-items:center;gap:10px;justify-content:center;margin-top:10px}
  .helper-note{text-align:center;font-size:12px;color:var(--muted);margin-top:6px}

  /* Toasts */
  .toast-wrap{position:fixed;right:16px;bottom:16px;display:flex;flex-direction:column;gap:8px;z-index:10000}
  .toast{
    background:#E9E2D6;color:var(--ink);padding:10px 12px;border-radius:10px;
    box-shadow:0 10px 30px rgba(0,0,0,.12);max-width:86vw
  }
  .toast--warn{background:#F2C97D;color:#4A2E00}.toast--error{background:#F3B8B8;color:#711313}

  /* Tiny preview list of last added (helps verify the write) */
  .preview{
    margin-top:14px;
    border:1px solid var(--line);
    background:var(--panel);
    border-radius:12px;
    padding:10px;
    max-width:980px;
  }
  .preview h3{margin:6px 0 10px;font-size:16px}
  .pv-row{display:flex;justify-content:space-between;border-top:1px dashed var(--line);padding:6px 0}
  .pv-row:first-child{border-top:none}
</style>
</head>
<body>

<!-- Toggle checkbox + hamburger -->
<input id="menu-check" type="checkbox" />
<label for="menu-check" class="hamburger" aria-label="Toggle menu" aria-controls="side" role="button" tabindex="0">
  <span class="bar"></span><span class="bar"></span><span class="bar"></span>
</label>

<!-- Off-canvas sidebar -->
<nav class="sidebar" id="side" role="navigation" aria-label="Main">
  <a href="index.html">Add New Stock</a>
  <a href="adjust.html">Adjust Stock</a>
  <a href="location.html">Location</a>
  <a href="goal.html">Set Stock Count Goal</a>
  <a href="history.html">History</a>
  <a href="status.html">Status</a>
  <hr>
  <button onclick="logout()">Logout</button>
</nav>

<!-- Click-away overlay -->
<label class="overlay" for="menu-check" aria-hidden="true"></label>

<!-- Toast container -->
<div class="toast-wrap" id="toast-wrap" aria-live="polite" aria-atomic="true"></div>

<main class="content">
  <section aria-labelledby="addPageTitle">
    <h2 id="addPageTitle">Add New Item</h2>

    <!-- Clean, aligned row -->
    <div class="add-form">
      <input type="text" id="newItemName" class="input" placeholder="Item name" autocomplete="off" />
      <input type="number" id="newItemQty" class="input" placeholder="Quantity" min="1" inputmode="numeric" />
      <select id="newItemLoc" class="input">
        <option>Old warehouse</option>
        <option>New warehouse</option>
        <option>Office</option>
      </select>
      <button class="btn" id="btnAddItem">Add Item</button>
    </div>

    <!-- ImageKit helper -->
    <div class="helper-row">
      <div class="card helper" aria-label="Image Helper">
        <div class="card-border-top"></div>
        <div class="img">üñºÔ∏è</div>
        <span style="font-size:18px;font-weight:700;text-align:center">Need an image URL?</span>
        <span class="job">Upload to ImageKit, copy the link, then set it via the üñº button on an item in Adjust.</span>
        <div class="helper-actions">
          <button type="button" class="btn" onclick="openImageKit()">Open ImageKit</button>
          <button type="button" class="btn" onclick="alert('In Adjust page, click the üñº button on a card to paste the ImageKit URL.')">Where to paste?</button>
        </div>
        <div class="helper-note">Tip: choose the ‚ÄúDirect URL‚Äù in ImageKit for best results.</div>
      </div>
    </div>

    <!-- Preview (shows the last few items so you know the write worked) -->
    <div class="preview" id="previewBox" hidden>
      <h3>Just added</h3>
      <div id="pvList"></div>
    </div>

    <div class="muted">Signed in as <strong id="signedAs"></strong>. Data syncs via Firebase (Firestore).</div>
  </section>
</main>

<!-- Firebase + App Logic -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
  import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
  import { getFirestore, collection, doc, addDoc, updateDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

  // ‚úÖ SAME project config as the rest of your site
  const firebaseConfig = {
    apiKey: "AIzaSyAL_C_bGiD-G_2g1jro7-OzxIlM0akRdTY",
    authDomain: "epedu-inventory-database.firebaseapp.com",
    projectId: "epedu-inventory-database",
    storageBucket: "epedu-inventory-database.appspot.com",
    messagingSenderId: "124437251040",
    appId: "1:124437251040:web:4989c73efc2f4afbf22185",
    measurementId: "G-GFEEP49VRP"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  signInAnonymously(auth).catch(console.error);
  const db = getFirestore(app);

  const CURRENT_USER = localStorage.getItem('auth_user') || 'Unknown';
  document.getElementById('signedAs').textContent = CURRENT_USER;

  /* Toasts */
  const toastWrap = document.getElementById('toast-wrap');
  function toast(msg, type='info', timeout=3400){
    const el = document.createElement('div');
    el.className = 'toast' + (type==='warn' ? ' toast--warn' : type==='error' ? ' toast--error' : '');
    el.textContent = msg;
    toastWrap.appendChild(el);
    if (timeout>0) setTimeout(() => el.remove(), timeout);
  }
  const notify = toast;

  /* Utils */
  function normLoc(raw){
    const s=(raw||'').trim().toLowerCase();
    if (s.startsWith('old')) return 'Old warehouse';
    if (s.startsWith('new')) return 'New warehouse';
    if (s.startsWith('off')) return 'Office';
    return null;
  }

  /* Firestore refs + local state */
  const colInventory = collection(db, "inventory");
  let inventory = [];            // entire current inventory
  let recentAdded = [];          // last few added (for preview box)

  onSnapshot(colInventory, (snap) => {
    inventory = snap.docs.map(d => ({ id:d.id, ...d.data() }));
  });

  /* ImageKit launcher */
  window.openImageKit = () =>
    window.open('https://imagekit.io/dashboard/media-library/L0VQLUVEVUNBVElPTiBJTlZFTlJZIFNUT0NLUw', '_blank', 'noopener');

  /* Add item */
  async function addNewItem() {
    const name = (document.getElementById('newItemName').value || '').trim().replace(/\s+/g,' ');
    const qty  = parseInt(document.getElementById('newItemQty').value,10);
    const location = normLoc(document.getElementById('newItemLoc').value);

    if (!name || !Number.isInteger(qty) || qty <= 0) { notify("Enter a valid name and a quantity ‚â• 1","warn"); return; }
    if (!location) { notify('Location must be "Old warehouse", "New warehouse", or "Office".',"warn"); return; }

    const existing = inventory.find(i => (i.name||'').toLowerCase() === name.toLowerCase());
    try{
      if (existing) {
        const incOld    = location === 'Old warehouse' ? qty : 0;
        const incNew    = location === 'New warehouse' ? qty : 0;
        const incOffice = location === 'Office'         ? qty : 0;

        const newOld    = Math.max(0, (existing.qtyOld ?? 0)    + incOld);
        const newNew    = Math.max(0, (existing.qtyNew ?? 0)    + incNew);
        const newOffice = Math.max(0, (existing.qtyOffice ?? 0) + incOffice);
        const total     = newOld + newNew + newOffice;

        // ‚úÖ These are the exact fields Adjust uses (it listens on "inventory")
        await updateDoc(doc(db, "inventory", existing.id), {
          qtyOld: newOld, qtyNew: newNew, qtyOffice: newOffice,
          qty: total, isNew:true, updatedAt: serverTimestamp()
        });

        addPreview({ name, qtyAdded: qty, location, total });
      } else {
        const qtyOld    = location === 'Old warehouse' ? qty : 0;
        const qtyNew    = location === 'New warehouse' ? qty : 0;
        const qtyOffice = location === 'Office'         ? qty : 0;
        const total     = qtyOld + qtyNew + qtyOffice;

        await addDoc(colInventory, {
          name, qtyOld, qtyNew, qtyOffice, qty: total,
          goal: 0, img: null, isNew: true,
          createdAt: serverTimestamp()
        });

        addPreview({ name, qtyAdded: qty, location, total });
      }
      notify(`Item "${name}" added to ${location}.`);
    } catch(err){
      console.error(err);
      notify('Failed to add item','error');
    }

    document.getElementById('newItemName').value = '';
    document.getElementById('newItemQty').value = '';
    document.getElementById('newItemName').focus();
  }

  document.getElementById('btnAddItem').addEventListener('click', addNewItem);
  document.getElementById('newItemName').addEventListener('keydown', (e)=>{ if (e.key==='Enter') addNewItem(); });
  document.getElementById('newItemQty').addEventListener('keydown', (e)=>{ if (e.key==='Enter') addNewItem(); });

  /* Tiny "Just added" preview so you can see writes immediately */
  const pvBox  = document.getElementById('previewBox');
  const pvList = document.getElementById('pvList');
  function addPreview(row){
    recentAdded.unshift(row);
    recentAdded = recentAdded.slice(0,5);
    pvBox.hidden = recentAdded.length === 0;
    pvList.innerHTML = recentAdded.map(r =>
      `<div class="pv-row"><div>${escapeHtml(r.name)} ‚Äî added ${r.qtyAdded} to <strong>${escapeHtml(r.location)}</strong></div><div>Total now: <strong>${r.total}</strong></div></div>`
    ).join('');
  }
  function escapeHtml(s){ return (s ?? '').toString().replace(/[&<>"]/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m])); }
</script>
</body>
</html>
