<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Inventory System ‚Äî Add New Stock</title>

<!-- Auth gate with role check -->
<script>
  const AUTH_OK   = localStorage.getItem('auth_v1') === 'ok';
  const AUTH_USER = localStorage.getItem('auth_user');
  const AUTH_ROLE = localStorage.getItem('auth_role'); // 'editor' | 'viewer'
  if (!AUTH_OK || !AUTH_USER) { window.location.replace('login.html'); }
  else if (AUTH_ROLE === 'viewer') { window.location.replace('viewer.html'); }
  function logout(){
    localStorage.removeItem('auth_v1');
    localStorage.removeItem('auth_user');
    localStorage.removeItem('auth_role');
    localStorage.removeItem('auth_time');
    window.location.replace('login.html');
  }
</script>

<style>
  /* ==== Light theme based on #F7F4EA ==== */
  :root{
    --nav-w:260px;
    --bg:#F7F4EA;
    --panel:#EEE6D8;
    --ink:#1F2937;
    --muted:#6B7280;
    --line:#D9CFC1;
    --accent:#0EA5A4;
    --chip:#EDE7DA;
    --helper-accent:#6D28D9;
    --helper-panel:#F3ECDF;
  }

  html,body{height:100%}
  body{
    margin:0;
    font-family:Arial,sans-serif;
    background:var(--bg);
    color:var(--ink)
  }
  h1,h2,h3{color:var(--ink)}
  .content{padding:20px;padding-top:80px;min-height:100vh;box-sizing:border-box}

  input,button,select,textarea{
    padding:8px;margin:4px;font-family:inherit;
    color:var(--ink);background:var(--panel);
    border:1px solid var(--line);caret-color:var(--ink);
  }
  button{border-radius:8px;cursor:pointer;transition:.15s}
  button:hover{background:var(--accent);color:#fff;border-color:var(--accent)}

  .muted{color:var(--muted);font-size:12px;margin-top:6px}

  /* Sidebar + hamburger */
  #menu-check{display:none}
  .hamburger{position:fixed;left:12px;top:12px;width:32px;display:flex;flex-direction:column;gap:7px;cursor:pointer;z-index:1200}
  .hamburger .bar{height:3px;background:var(--ink);border-radius:10px}

  .sidebar{
    position:fixed;inset:0 auto 0 0;width:var(--nav-w);
    background:var(--panel);padding:20px;
    transform:translateX(-100%);transition:.3s;z-index:1100;overflow:auto;
    box-shadow:0 10px 30px rgba(0,0,0,.08);border-right:1px solid var(--line)
  }
  .sidebar a,.sidebar button{
    display:block;width:100%;margin-bottom:10px;padding:10px;text-align:left;
    border-radius:8px;text-decoration:none;color:inherit;
    border:1px solid var(--line);background:transparent
  }
  .sidebar a:hover{background:var(--accent);color:#fff;border-color:var(--accent)}
  #menu-check:checked~.sidebar{transform:translateX(0)}

  label.overlay{position:fixed;inset:0;background:rgba(0,0,0,.25);opacity:0;visibility:hidden;transition:.3s;z-index:1090}
  #menu-check:checked~label.overlay{opacity:1;visibility:visible}

  /* Fancy input */
  .input-container{position:relative;margin:8px 4px}
  .input{
    width:100%;padding:10px;height:40px;
    border:2px solid var(--line);border-top:none;border-bottom:none;
    font-size:16px;background:transparent;outline:none;
    box-shadow:7px 7px 0 0 var(--line);
    transition:.5s;color:var(--ink);caret-color:var(--ink);
  }
  .label{position:absolute;top:10px;left:10px;color:var(--ink);transition:.5s;transform:scale(0);background:var(--bg);padding:0 4px}
  .input:focus~.label{top:-10px;transform:scale(1)}

  /* Helper card */
  .helper-row{display:grid;grid-template-columns:1fr;gap:16px;margin-top:12px}
  .card.helper{
    border-radius:15px;background:var(--helper-panel);padding:16px;
    box-shadow:0 8px 22px rgba(0,0,0,.08);border:1px solid var(--line)
  }
  .card-border-top{width:60%;height:3px;background:var(--helper-accent);margin:6px auto 10px;border-radius:0 0 15px 15px}
  .card.helper .img{width:70px;height:70px;background:var(--panel);border-radius:15px;margin:14px auto;display:flex;align-items:center;justify-content:center;font-size:24px;border:1px solid var(--line)}
  .card.helper span{display:block;text-align:center}
  .card.helper .job{font-size:12px;color:var(--muted)}
  .card.helper button{padding:10px 16px;margin:12px auto 6px;border-radius:8px;border:1px solid var(--accent);background:var(--accent);color:#fff;font-weight:600;cursor:pointer}
  .card.helper button:hover{filter:brightness(.95)}
  .helper-note{text-align:center;font-size:12px;color:var(--muted);margin-top:4px}

  /* Toasts */
  .toast-wrap{position:fixed;right:16px;bottom:16px;display:flex;flex-direction:column;gap:8px;z-index:10000}
  .toast{background:#E9E2D6;color:var(--ink);padding:10px 12px;border-radius:8px;box-shadow:0 10px 30px rgba(0,0,0,.12)}
  .toast--warn{background:#F2C97D;color:#4A2E00}
  .toast--error{background:#F3B8B8;color:#711313}
</style>
</head>
<body>

<!-- Sidebar -->
<input id="menu-check" type="checkbox" />
<label for="menu-check" class="hamburger"><span class="bar"></span><span class="bar"></span><span class="bar"></span></label>

<nav class="sidebar">
  <a href="index.html">Add New Stock</a>
  <a href="adjust.html">Adjust Stock</a>
  <a href="location.html">Location</a>
  <a href="goal.html">Set Stock Count Goal</a>
  <a href="history.html">History</a>
  <a href="status.html">Status</a>
  <hr>
  <button onclick="logout()">Logout</button>
</nav>
<label class="overlay" for="menu-check"></label>

<!-- Toasts -->
<div class="toast-wrap" id="toast-wrap"></div>

<main class="content">
  <h2>Add New Item</h2>
  <div style="display:grid;grid-template-columns:minmax(260px,1fr) 160px minmax(220px,1fr) auto;gap:12px;max-width:900px">
    <div class="input-container">
      <input type="text" id="newItemName" class="input" placeholder=" " />
      <label for="newItemName" class="label">Item Name</label>
    </div>
    <input type="number" id="newItemQty" placeholder="Quantity" min="1"/>
    <div class="input-container">
      <select id="newItemLoc" class="input">
        <option>Old warehouse</option>
        <option>New warehouse</option>
        <option>Office</option>
      </select>
      <label for="newItemLoc" class="label">Location</label>
    </div>
    <button onclick="addNewItem()">Add Item</button>
  </div>

  <div class="helper-row">
    <div class="card helper">
      <div class="card-border-top"></div>
      <div class="img">üñºÔ∏è</div>
      <span>Need an image URL?</span>
      <span class="job">Upload to ImageKit, copy the link, then set it via the üñº button on an item.</span>
      <button type="button" onclick="openImageKit()">Open ImageKit</button>
      <div class="helper-note">Tip: use the Direct URL for images.</div>
    </div>
  </div>

  <div class="muted">Signed in as <strong id="signedAs"></strong>. Data syncs via Firebase (Firestore).</div>
</main>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
  import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
  import { getFirestore, collection, doc, addDoc, updateDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

  // ‚úÖ New Firebase project config
  const firebaseConfig = {
    apiKey: "AIzaSyAL_C_bGiD-G_2g1jro7-OzxIlM0akRdTY",
    authDomain: "epedu-inventory-database.firebaseapp.com",
    projectId: "epedu-inventory-database",
    storageBucket: "epedu-inventory-database.appspot.com",
    messagingSenderId: "124437251040",
    appId: "1:124437251040:web:4989c73efc2f4afbf22185",
    measurementId: "G-GFEEP49VRP"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  signInAnonymously(auth).catch(console.error);
  const db = getFirestore(app);

  const CURRENT_USER = localStorage.getItem('auth_user') || 'Unknown';
  document.getElementById('signedAs').textContent = CURRENT_USER;

  // Toasts
  const toastWrap = document.getElementById('toast-wrap');
  function notify(msg,type='info',timeout=3000){
    const el=document.createElement('div');
    el.className='toast'+(type==='warn'?' toast--warn':type==='error'?' toast--error':'');
    el.innerHTML=msg;
    toastWrap.appendChild(el);
    setTimeout(()=>el.remove(),timeout);
  }

  // Inventory snapshot
  let inventory=[];
  const colInventory = collection(db,"inventory");
  onSnapshot(colInventory,snap=>{inventory=snap.docs.map(d=>({id:d.id,...d.data()}));});

  // Open ImageKit
  window.openImageKit=()=>window.open("https://imagekit.io/dashboard/media-library/L0VQLUVEVUNBVElPTiBJTlZFTlJZIFNUT0NLUw","_blank","noopener");

  // Normalize location
  function normLoc(raw){
    const s=(raw||'').toLowerCase();
    if(s.includes("old")) return "Old warehouse";
    if(s.includes("new")) return "New warehouse";
    if(s.includes("office")) return "Office";
    return null;
  }

  // Add new item
  window.addNewItem=async()=>{
    const name=document.getElementById("newItemName").value.trim();
    const qty=parseInt(document.getElementById("newItemQty").value,10);
    const loc=normLoc(document.getElementById("newItemLoc").value);
    if(!name||!qty||qty<=0){notify("Enter valid name and quantity","warn");return;}
    if(!loc){notify("Select location","warn");return;}
    const existing=inventory.find(i=>(i.name||"").toLowerCase()===name.toLowerCase());
    try{
      if(existing){
        const newOld=(existing.qtyOld||0)+(loc==="Old warehouse"?qty:0);
        const newNew=(existing.qtyNew||0)+(loc==="New warehouse"?qty:0);
        const newOffice=(existing.qtyOffice||0)+(loc==="Office"?qty:0);
        await updateDoc(doc(db,"inventory",existing.id),{
          qtyOld:newOld,qtyNew:newNew,qtyOffice:newOffice,
          qty:newOld+newNew+newOffice,updatedAt:serverTimestamp()
        });
      }else{
        await addDoc(colInventory,{
          name,qtyOld:loc==="Old warehouse"?qty:0,qtyNew:loc==="New warehouse"?qty:0,qtyOffice:loc==="Office"?qty:0,
          qty:qty,goal:0,img:null,createdAt:serverTimestamp()
        });
      }
      notify(`Item "${name}" added to ${loc}`);
    }catch(e){console.error(e);notify("Failed to add item","error");}
    document.getElementById("newItemName").value="";
    document.getElementById("newItemQty").value="";
  };
</script>
</body>
</html>
