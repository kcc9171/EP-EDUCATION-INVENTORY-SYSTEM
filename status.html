<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Inventory System — Status</title>

<script>
  const AUTH_OK   = localStorage.getItem('auth_v1') === 'ok';
  const AUTH_USER = localStorage.getItem('auth_user');
  const AUTH_ROLE = localStorage.getItem('auth_role');
  if (!AUTH_OK || !AUTH_USER) { window.location.replace('login.html'); }
  else if (AUTH_ROLE === 'viewer') { window.location.replace('viewer.html'); }
  function logout(){
    localStorage.removeItem('auth_v1'); localStorage.removeItem('auth_user');
    localStorage.removeItem('auth_role'); localStorage.removeItem('auth_time');
    window.location.replace('login.html');
  }
</script>

<style>
  /* ==== Light theme based on #F7F4EA ==== */
  :root{
    --nav-w:260px;
    --bg:#F7F4EA;
    --s-card:#EEE6D8;
    --s-ink:#1F2937;
    --s-muted:#6B7280;
    --s-line:#D9CFC1;
    --s-badge:#EDE7DA;
    --accent:#0EA5A4;
  }

  body{margin:0;font-family:Arial,sans-serif;background:var(--bg);color:var(--s-ink)}
  h2{color:var(--s-ink)}
  .content{padding:20px;padding-top:80px;min-height:100vh;box-sizing:border-box}

  input,button,select,textarea{
    padding:8px;margin:4px;font-family:inherit;
    color:var(--s-ink);background:var(--s-card);
    border:1px solid var(--s-line);caret-color:var(--s-ink);
  }
  input::placeholder,textarea::placeholder{color:var(--s-muted)}

  button{border-radius:8px;cursor:pointer;transition:.15s}
  button:hover{background:var(--accent);color:#fff;border-color:var(--accent)}
  .action-btn{background:var(--accent);color:#fff;border:1px solid var(--accent)}
  .action-btn:hover{filter:brightness(.95)}

  #menu-check{display:none}
  .hamburger{position:fixed;left:12px;top:12px;width:32px;display:flex;flex-direction:column;gap:7px;
    cursor:pointer;z-index:1200;transition:.3s}
  .hamburger .bar{height:3px;background:var(--s-ink);border-radius:10px;transition:.35s}
  .hamburger .bar1,.hamburger .bar3{width:18px}.hamburger .bar2{width:28px}
  #menu-check:checked+label.hamburger{transform:translateX(var(--nav-w))}
  #menu-check:checked+label.hamburger .bar1{transform:translateY(10px) rotate(45deg);width:28px}
  #menu-check:checked+label.hamburger .bar2{opacity:0}
  #menu-check:checked+label.hamburger .bar3{transform:translateY(-10px) rotate(-45deg);width:28px}

  .sidebar{position:fixed;inset:0 auto 0 0;width:var(--nav-w);background:var(--s-card);
    padding:20px;box-sizing:border-box;transform:translateX(-100%);transition:.3s;z-index:1100;
    border-right:1px solid var(--s-line);box-shadow:0 10px 30px rgba(0,0,0,.08)}
  .sidebar a,.sidebar button{display:block;width:100%;margin-bottom:10px;padding:10px;
    text-align:left;border-radius:8px;text-decoration:none;color:inherit;
    border:1px solid var(--s-line);background:transparent}
  .sidebar a:hover{background:var(--accent);color:#fff;border-color:var(--accent)}
  #menu-check:checked~.sidebar{transform:translateX(0)}
  label.overlay{position:fixed;inset:0;background:rgba(0,0,0,.25);opacity:0;visibility:hidden;transition:.3s;z-index:1090}
  #menu-check:checked~label.overlay{opacity:1;visibility:visible}

  .status-toolbar{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0 16px}
  .input-container{position:relative;flex:1}
  .input{width:100%;padding:10px;height:40px;border:2px solid var(--s-line);
    border-top:none;border-bottom:none;font-size:16px;background:transparent;
    box-shadow:7px 7px 0 0 var(--s-line);color:var(--s-ink)}
  .label{position:absolute;top:10px;left:10px;color:var(--s-ink);background:var(--bg);padding:0 4px;transition:.3s}
  .input:focus~.label{top:-10px;transform:scale(.9)}

  .status-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px}
  .status-card{background:var(--s-card);border:1px solid var(--s-line);border-radius:16px;
    box-shadow:0 8px 24px rgba(15,23,42,.06);padding:14px}
  .status-card__top{display:flex;justify-content:space-between;font-size:12px;color:var(--s-muted)}
  .status-card__title{font-weight:700}
  .status-meta{font-size:12px;color:var(--s-muted);display:grid;grid-template-columns:auto auto;gap:4px 14px}
  .status-chip{border-radius:999px;padding:2px 8px;font-size:12px}
  .chip--loan{background:#dcfce7;color:#065f46}
  .chip--rent{background:#fef3c7;color:#92400e}
  .chip--where{background:#e0e7ff;color:#3730a3}
  .status-del,.status-edit{border:1px solid var(--s-line);border-radius:8px;padding:2px 6px;font-size:12px;cursor:pointer}

  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.25);z-index:9999}
  .modal.open{display:flex}
  .modal-card{width:95%;max-width:520px;background:var(--s-card);border-radius:8px;padding:16px;border:1px solid var(--s-line)}
  .toast-wrap{position:fixed;right:16px;bottom:16px;display:flex;flex-direction:column;gap:8px;z-index:10000}
  .toast{background:#E9E2D6;color:var(--s-ink);padding:10px 12px;border-radius:8px}
</style>
</head>
<body>

<input id="menu-check" type="checkbox" />
<label for="menu-check" class="hamburger"><span class="bar bar1"></span><span class="bar bar2"></span><span class="bar bar3"></span></label>

<nav class="sidebar">
  <a href="index.html">Add New Stock</a>
  <a href="adjust.html">Adjust Stock</a>
  <a href="location.html">Location</a>
  <a href="goal.html">Set Stock Count Goal</a>
  <a href="history.html">History</a>
  <a href="status.html">Status</a>
  <hr>
  <button onclick="logout()">Logout</button>
</nav>
<label class="overlay" for="menu-check"></label>

<div class="toast-wrap" id="toast-wrap"></div>

<main class="content">
  <h2>Status</h2>
  <div class="status-toolbar">
    <div class="input-container">
      <input id="status-search" type="text" class="input" placeholder=" ">
      <label for="status-search" class="label">Search order / item / remarks…</label>
    </div>
    <button class="action-btn" id="status-add-btn">+ New Status</button>
  </div>
  <div id="statusList" class="status-list"></div>
</main>

<!-- Modal -->
<div id="statusModal" class="modal">
  <div class="modal-card">
    <h3 id="status-title">Add Status</h3>
    <label>Order ID <input id="st-order" type="text" class="input"></label>
    <label>Item Name <input id="st-item" type="text" class="input"></label>
    <label>Quantity <input id="st-qty" type="number" min="1" value="1" class="input"></label>
    <label>Status <select id="st-type" class="input"><option>Loan</option><option>Rent</option></select></label>
    <label>Location <select id="st-where" class="input"><option>Client</option><option>On the way back</option><option>Office</option></select></label>
    <label>Remarks <textarea id="st-remarks" rows="3" class="input"></textarea></label>
    <div class="modal-actions"><button id="st-cancel">Cancel</button><button id="st-save" class="action-btn">Save</button></div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
  import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAL_C_bGiD-G_2g1jro7-OzxIlM0akRdTY",
    authDomain: "epedu-inventory-database.firebaseapp.com",
    projectId: "epedu-inventory-database",
    storageBucket: "epedu-inventory-database.appspot.com",
    messagingSenderId: "124437251040",
    appId: "1:124437251040:web:4989c73efc2f4afbf22185",
    measurementId: "G-GFEEP49VRP"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);
  signInAnonymously(auth).catch(console.error);

  const CURRENT_USER = localStorage.getItem('auth_user') || 'Unknown';

  const toastWrap=document.getElementById('toast-wrap');
  function notify(msg){const el=document.createElement('div');el.className='toast';el.textContent=msg;toastWrap.appendChild(el);setTimeout(()=>el.remove(),3000);}

  const colStatuses=collection(db,"statuses");
  let statuses=[];
  onSnapshot(query(colStatuses,orderBy("ts","desc")),(snap)=>{statuses=snap.docs.map(d=>({id:d.id,...d.data()}));renderStatuses();});

  const modal=document.getElementById('statusModal');const stSave=document.getElementById('st-save');const stCancel=document.getElementById('st-cancel');
  let editingId=null;

  document.getElementById('status-add-btn').onclick=()=>{editingId=null;modal.classList.add('open');};
  stCancel.onclick=()=>modal.classList.remove('open');

  stSave.onclick=async()=>{
    const order=document.getElementById('st-order').value.trim();
    const item=document.getElementById('st-item').value.trim();
    const qty=parseInt(document.getElementById('st-qty').value,10);
    const status=document.getElementById('st-type').value;
    const where=document.getElementById('st-where').value;
    const remarks=document.getElementById('st-remarks').value.trim();
    if(!order||!item||!qty){notify("Fill all fields");return;}
    try{
      if(editingId){await updateDoc(doc(db,"statuses",editingId),{order,item,qty,status,where,remarks,editor:CURRENT_USER,updatedAt:serverTimestamp()});notify("Updated");}
      else{await addDoc(colStatuses,{ts:serverTimestamp(),order,item,qty,status,where,remarks,actor:CURRENT_USER});notify("Added");}
      modal.classList.remove('open');
    }catch(e){console.error(e);notify("Error");}
  };

  function renderStatuses(){
    const wrap=document.getElementById('statusList');wrap.innerHTML='';
    let rows=statuses;const q=(document.getElementById('status-search').value||'').toLowerCase();
    if(q)rows=rows.filter(r=>(r.order||'').toLowerCase().includes(q)||(r.item||'').toLowerCase().includes(q)||(r.remarks||'').toLowerCase().includes(q)||(r.where||'').toLowerCase().includes(q));
    rows.forEach(r=>{
      const d=document.createElement('div');d.className='status-card';
      const dt=r.ts?.toDate?r.ts.toDate().toLocaleString():'';
      const chip=r.status==='Rent'?'chip--rent':'chip--loan';
      d.innerHTML=`<div class="status-card__top"><span>${dt}</span><div><span class="status-chip ${chip}">${r.status}</span><span class="status-chip chip--where">${r.where}</span><button class="status-edit">✏️</button><button class="status-del">🗑</button></div></div>
      <div class="status-card__title">Order: ${r.order}</div><div class="status-meta"><div>Item</div><div>${r.item}</div><div>Qty</div><div>${r.qty}</div></div>${r.remarks?`<div>${r.remarks}</div>`:''}`;
      d.querySelector('.status-edit').onclick=()=>{editingId=r.id;document.getElementById('st-order').value=r.order;document.getElementById('st-item').value=r.item;document.getElementById('st-qty').value=r.qty;document.getElementById('st-type').value=r.status;document.getElementById('st-where').value=r.where;document.getElementById('st-remarks').value=r.remarks;modal.classList.add('open');};
      d.querySelector('.status-del').onclick=async()=>{if(confirm("Delete?"))await deleteDoc(doc(db,"statuses",r.id));};
      wrap.appendChild(d);
    });
  }
  document.getElementById('status-search').oninput=renderStatuses;
  window.addEventListener('keydown',e=>{if(e.key==="Escape")modal.classList.remove('open');});
</script>
</body>
</html>
