<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Inventory Viewer</title>
  <link rel="icon" href="https://media.licdn.com/dms/image/v2/C560BAQH1e7RqZpFCqA/company-logo_200_200/company-logo_200_200/0/1630649511750?e=2147483647&v=beta&t=Xt8U3KJxbI4FiV1rmcsehbP6Y2XdByD6pEP8X7K378g">
  <style>
    :root{
      --bg:#F7F4EA;
      --panel:#EEE6D8;
      --ink:#1F2937;
      --muted:#6B7280;
      --line:#D9CFC1;
      --accent:#0EA5A4;
      --chip:#EDE7DA;
      --header-bg:#F0E8DB;
      --shadow:0 12px 30px rgba(0,0,0,.08);
    }
    body{margin:0;font-family:Arial,sans-serif;background:var(--bg);color:var(--ink)}
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    .bar{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:44px;height:44px;border-radius:10px;object-fit:cover;box-shadow:0 6px 14px rgba(0,0,0,.08);border:1px solid var(--line)}
    .title{margin:0;font-size:28px;font-weight:800}
    .info{color:var(--muted);font-size:13px}
    .right{display:flex;gap:10px;align-items:center}
    .logout{padding:6px 12px;border:1px solid var(--accent);border-radius:8px;background:var(--accent);color:#fff;cursor:pointer}
    .tabs{display:flex;gap:8px;margin:10px 0}
    .tab{padding:8px 12px;border:1px solid var(--line);border-radius:8px;background:var(--panel);cursor:pointer}
    .tab.active,.tab:hover{background:var(--accent);color:#fff;border-color:var(--accent)}
    .section{display:none}.section.show{display:block}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin:12px 0}
    input,select,button{padding:8px 10px;border:1px solid var(--line);border-radius:8px;background:var(--panel);color:var(--ink)}
    button:hover{background:var(--accent);color:#fff;border-color:var(--accent)}
    .pill{padding:2px 8px;border:1px solid var(--line);border-radius:999px;font-size:12px;background:var(--chip)}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(210px,1fr));gap:16px}
    .card{width:210px;height:260px;background:var(--panel);border-radius:16px;border:1px solid var(--line);box-shadow:var(--shadow);overflow:hidden}
    .card__image{height:110px;background:var(--header-bg);background-size:cover;background-position:center}
    .qty-badge{position:absolute;top:10px;right:10px;background:var(--ink);color:#fff;font-size:12px;padding:2px 6px;border-radius:999px}
    .badge-low{position:absolute;top:10px;left:10px;background:#e11d48;color:#fff;font-size:11px;padding:2px 6px;border-radius:999px}
    table{width:100%;border-collapse:collapse}
    th,td{border:1px solid var(--line);padding:6px;font-size:13px}
    thead{background:var(--header-bg);color:var(--muted)}
    .status-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px}
    .status-card{background:var(--panel);border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow);padding:14px}
    .status-chip{border-radius:999px;padding:2px 8px;font-size:12px}
    .chip--loan{background:#dcfce7;color:#065f46}
    .chip--rent{background:#fef3c7;color:#92400e}
    .loc-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(190px,1fr));gap:16px}
    .loc-card{background:var(--panel);border-radius:16px;border:1px solid var(--line);box-shadow:var(--shadow);overflow:hidden}
    .loc-card__image{height:100px;background:var(--header-bg);background-size:cover;background-position:center}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="bar">
      <div class="brand">
        <img class="logo" alt="Company logo" src="https://media.licdn.com/dms/image/v2/C560BAQH1e7RqZpFCqA/company-logo_200_200/company-logo_200_200/0/1630649511750?e=2147483647&v=beta&t=Xt8U3KJxbI4FiV1rmcsehbP6Y2XdByD6pEP8X7K378g"/>
        <div>
          <h1 class="title">Inventory (Read-only)</h1>
          <p class="info">Signs in anonymously, shows live data. Editing is disabled.</p>
        </div>
      </div>
      <div class="right">
        <span id="signedAs"></span>
        <button id="logoutBtn" class="logout">Logout</button>
      </div>
    </div>

    <div class="tabs">
      <div class="tab active" data-tab="inv">Inventory</div>
      <div class="tab" data-tab="hist">History</div>
      <div class="tab" data-tab="status">Status</div>
      <div class="tab" data-tab="loc">Location</div>
    </div>

    <section id="inv" class="section show">
      <div class="toolbar"><input id="inv-search" type="text" placeholder="Search items…"/><span id="inv-count" class="pill">0 items</span></div>
      <div id="grid" class="grid"></div>
    </section>

    <section id="hist" class="section">
      <div class="toolbar">
        <input id="hist-search" type="text" placeholder="Search history…" style="min-width:240px;">
        <select id="hist-item-filter"><option value="">All items</option></select>
        <span id="hist-count" class="pill">0 records</span>
        <div style="flex:1"></div><button id="export-btn">Export CSV</button>
      </div>
      <table><thead><tr><th>Date/Time</th><th>Item</th><th>Location</th><th>Change</th><th>Qty After</th><th>By</th><th>Purpose</th><th>For</th></tr></thead><tbody id="hist-body"></tbody></table>
    </section>

    <section id="status" class="section">
      <div class="toolbar"><input id="status-search" type="text" placeholder="Search status…" style="min-width:240px;"><span id="status-count" class="pill">0 records</span></div>
      <div id="statusList" class="status-list"></div>
    </section>

    <section id="loc" class="section">
      <div class="toolbar"><input id="loc-search" type="text" placeholder="Search locations…" style="min-width:240px;"><span id="loc-count" class="pill">0 cards</span></div>
      <div id="locationGrid" class="loc-grid"></div>
    </section>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getAuth, signInAnonymously, signOut } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, query, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAL_C_bGiD-G_2g1jro7-OzxIlM0akRdTY",
      authDomain: "epedu-inventory-database.firebaseapp.com",
      projectId: "epedu-inventory-database",
      storageBucket: "epedu-inventory-database.appspot.com",
      messagingSenderId: "124437251040",
      appId: "1:124437251040:web:4989c73efc2f4afbf22185"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app); signInAnonymously(auth).catch(console.error);
    const db = getFirestore(app);

    // Logout
    document.getElementById('logoutBtn').onclick = async()=>{try{await signOut(auth);}catch{}localStorage.clear();location.replace('login.html');};
    document.getElementById('signedAs').textContent = "Signed in as Viewer";

    const colInventory=collection(db,"inventory"), colAdjustments=collection(db,"adjustments"), colStatuses=collection(db,"statuses"), colLocations=collection(db,"locations");
    let inventory=[],adjustments=[],statuses=[],locations=[];

    // Tabs
    document.querySelectorAll('.tab').forEach(t=>t.onclick=()=>{document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));document.querySelectorAll('.section').forEach(s=>s.classList.remove('show'));t.classList.add('active');document.getElementById(t.dataset.tab).classList.add('show');});

    // Helpers
    const $=s=>document.querySelector(s);
    const esc=s=>(s??'').toString().replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    const toLocal=ts=>ts?.toDate?ts.toDate().toLocaleString():'';
    const csvEscape=v=>/[",\n]/.test(v)?`"${v.replace(/"/g,'""')}"`:v;

    function totalQty(i){return (i.qtyOld||0)+(i.qtyNew||0)+(i.qtyOffice||0)||(i.qty||0);}

    // Listeners
    onSnapshot(colInventory,snap=>{inventory=snap.docs.map(d=>({id:d.id,...d.data()}));renderInventory();});
    onSnapshot(query(colAdjustments,orderBy("ts","desc")),snap=>{adjustments=snap.docs.map(d=>({id:d.id,...d.data()}));renderHistory();populateHistFilter();});
    onSnapshot(query(colStatuses,orderBy("ts","desc")),snap=>{statuses=snap.docs.map(d=>({id:d.id,...d.data()}));renderStatuses();});
    onSnapshot(colLocations,snap=>{locations=snap.docs.map(d=>({id:d.id,...d.data()}));renderLocations();});

    // Inventory
    $('#inv-search').oninput=renderInventory;
    function renderInventory(){const q=$('#inv-search').value.toLowerCase();const rows=inventory.filter(i=>(i.name||'').toLowerCase().includes(q));$('#inv-count').textContent=`${rows.length} items`;const grid=$('#grid');grid.innerHTML='';rows.forEach(i=>{const total=totalQty(i);grid.innerHTML+=`<div class="card"><div class="card__image" style="background-image:url('${esc(i.img||'')}')"></div><div class="content"><p class="name">${esc(i.name)}</p><p class="muted">Qty ${total} (Goal ${i.goal||0})</p></div></div>`;});}

    // History
    $('#hist-search').oninput=renderHistory;$('#hist-item-filter').onchange=renderHistory;
    function populateHistFilter(){const sel=$('#hist-item-filter');const names=[...new Set(adjustments.map(a=>a.item).filter(Boolean))].sort();sel.innerHTML='<option value="">All</option>'+names.map(n=>`<option>${esc(n)}</option>`).join('');}
    function renderHistory(){const q=$('#hist-search').value.toLowerCase();const filter=$('#hist-item-filter').value;let rows=adjustments;if(q)rows=rows.filter(r=>(r.item||'').toLowerCase().includes(q)||(r.actor||'').toLowerCase().includes(q)||(r.purpose||'').toLowerCase().includes(q));if(filter)rows=rows.filter(r=>r.item===filter);$('#hist-count').textContent=`${rows.length} records`;const tbody=$('#hist-body');tbody.innerHTML=rows.map(r=>`<tr><td>${toLocal(r.ts)}</td><td>${esc(r.item)}</td><td>${esc(r.location||'')}</td><td>${r.delta}</td><td>${r.qtyAfter}</td><td>${esc(r.actor||'')}</td><td>${esc(r.purpose||'')}</td><td>${esc(r.forWhom||'')}</td></tr>`).join('');}
    $('#export-btn').onclick=async()=>{const snap=await getDocs(query(colAdjustments,orderBy("ts","desc")));const rows=snap.docs.map(d=>d.data());const header=['Date/Time','Item','Location','Change','QtyAfter','By','Purpose','For'];const csv=[header.join(',')];rows.forEach(r=>csv.push([toLocal(r.ts),csvEscape(r.item||''),csvEscape(r.location||''),r.delta,csvEscape(r.qtyAfter||''),csvEscape(r.actor||''),csvEscape(r.purpose||''),csvEscape(r.forWhom||'')].join(',')));const blob=new Blob(["\uFEFF"+csv.join('\n')],{type:'text/csv'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='history.csv';a.click();};

    // Status
    $('#status-search').oninput=renderStatuses;
    function renderStatuses(){const q=$('#status-search').value.toLowerCase();const rows=statuses.filter(r=>(r.order||'').toLowerCase().includes(q));$('#status-count').textContent=`${rows.length} records`;$('#statusList').innerHTML=rows.map(r=>`<div class="status-card"><div class="status-card__top"><span>${toLocal(r.ts)}</span><span class="status-chip ${r.status==='Rent'?'chip--rent':'chip--loan'}">${r.status}</span></div><div class="status-card__title">Order: ${esc(r.order)}</div><div>Item: ${esc(r.item)} | Qty: ${r.qty}</div></div>`).join('');}

    // Locations
    $('#loc-search').oninput=renderLocations;
    function renderLocations(){const q=$('#loc-search').value.toLowerCase();const rows=locations.filter(l=>(l.name||'').toLowerCase().includes(q));$('#loc-count').textContent=`${rows.length} cards`;$('#locationGrid').innerHTML=rows.map(l=>`<div class="loc-card"><div class="loc-card__image" style="background-image:url('${esc(l.img||'')}')"></div><div><b>${esc(l.name)}</b><p>${esc(l.description||'')}</p></div></div>`).join('');}
  </script>
</body>
</html>
